<!DOCTYPE html>
<html lang="zh-Hant" class="dark">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ©‹ç‰Œ è¨ˆåˆ†å™¨</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- manifest -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#111827" />

  <!-- Apple support -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png" />
  <style>
    body {
      background-color: #0f172a;
      color: white;
    }

    input {
      color: black !important;
      background-color: #ffffff !important;
      /* æ·ºç°è‰²èƒŒæ™¯ï¼Œé…æ·±è‰²å­— */
      border-radius: 0.375rem;
      /* Tailwind çš„ rounded */
      padding: 0.5rem;
    }

    input:focus {
      outline: none;
      box-shadow: 0 0 0 2px #3b82f6;
      /* è—è‰²èšç„¦é‚Šæ¡† */
    }

    .dark input {
      background-color: #374151;
      /* æ·±ç°è‰²èƒŒæ™¯ */
      color: white;
      /* ç™½è‰²å­— */
    }

    .dark input:focus {
      box-shadow: 0 0 0 2px #60a5fa;
      /* æ·±è‰²æ¨¡å¼ä¸‹çš„è—è‰²èšç„¦é‚Šæ¡† */
    }
  </style>
</head>

<body class="p-4">
  <div class="max-w-xl mx-auto space-y-6">
    <h1 class="text-5xl text-center">ğŸƒ</h1>
    <h1 class="text-3xl font-bold text-center mb-4">æ©‹ç‰Œ è¨ˆåˆ†å™¨</h1>

    <div id="player-setup" class="space-y-2">
      <label class="block mb-1">ç©å®¶åç¨± (ç”¨ç©ºæ ¼åˆ†éš”):</label>
      <input id="player-names" type="text" class="w-full p-2 rounded" placeholder="ä¾‹å¦‚: å®‡çª å°ç¾ å®‰å¦‚çœŸ ROSE" />
      <button onclick="startGame()"
        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded mt-2 w-full">é–‹å§‹éŠæˆ²</button>
    </div>

    <div id="game" class="hidden space-y-4">

      <div>
        <p id="roundDisplay" class="font-bold">ç¬¬ <span id="round-number">1</span> å›åˆ</p>
        <p>é¦–ç™¼ç©å®¶: <span id="starting-player" class="text-yellow-300 font-semibold"></span></p>
      </div>

      <!-- ä¼°å¢©éšæ®µ -->
      <div id="bid-section" class="space-y-2">
        <p class="font-semibold">ä¼°å¢©éšæ®µ</p>
        <form onsubmit="submitBids(); return false;" class="space-y-2">
          <div id="bid-inputs" class="space-y-2"></div>
          <div id="bidSumStatus" style="margin-top: 10px;"></div>
          <button type="submit" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded w-full">æäº¤ä¼°å¢©</button>
        </form>
        <div id="bid-warning" class="text-red-500"></div>
      </div>

      <!-- å¯¦éš›å¢©æ•¸éšæ®µ -->
      <div id="tricks-section" class="hidden space-y-2">
        <p class="font-semibold">å¯¦éš›å¢©æ•¸éšæ®µ</p>
        <form onsubmit="submitTricks(); return false;" class="space-y-2">
          <div id="trick-inputs" class="space-y-2"></div>
          <button type="submit" class="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded w-full">æäº¤å¯¦éš›å¢©æ•¸</button>
        </form>
      </div>

      <!-- åˆ†æ•¸æ¿ -->
      <div>
        <h2 class="text-lg font-bold">åˆ†æ•¸æ¿</h2>
        <table class="w-full text-sm border-collapse border border-gray-700" id="scoreboard">
        </table>
      </div>

    </div>
  </div>

  <script>
    let players = [];
    let scores = [];
    let round = 1;
    let maxRounds = 1;
    let dealerIndex = 0;
    let currentBids = [];
    let currentTricks = [];
    let rounds = [];

    function startGame() {
      const namesInput = document.getElementById("player-names").value;
      players = namesInput.split(" ").map(n => n.trim()).filter(Boolean);
      if (players.length < 2) return alert("è«‹è¼¸å…¥è‡³å°‘å…©ä½ç©å®¶");
      scores = Array(players.length).fill(0);
      maxRounds = Math.floor(52 / players.length);
      document.getElementById("player-setup").classList.add("hidden");
      document.getElementById("game").classList.remove("hidden");
      updateRoundDisplay();
      showBidInputs();
      clearTrickSection();
      updateScoreboard();
    }

    function updateRoundDisplay() {
      const display = document.getElementById("roundDisplay");
      display.innerText = `ç¬¬ ${round} å›åˆ`;

      const reminder = document.createElement("span");
      reminder.innerText = `ï¼ˆ${round}å¼µæ‰‹ç‰Œï¼‰`;
      reminder.style.color = "#df3079";
      reminder.style.marginLeft = "8px";
      display.appendChild(reminder);

      if (round === maxRounds) {
        const finalNote = document.createElement("span");
        finalNote.innerText = "ï¼ˆæœ¬å›åˆç‚ºæœ€çµ‚å›åˆï¼‰";
        finalNote.style.color = "gold";
        finalNote.style.marginLeft = "8px";
        display.appendChild(finalNote);
      }

      const startingPlayer = document.getElementById("starting-player");
      startingPlayer.innerText = players[dealerIndex];
      startingPlayer.classList.add("text-yellow-300", "font-semibold");

    }


    function showBidInputs() {
      currentBids = Array(players.length).fill(null);
      const container = document.getElementById("bid-inputs");
      container.innerHTML = "";
      for (let i = 0; i < players.length; i++) {
        const idx = (dealerIndex + i) % players.length;
        const div = document.createElement("div");
        div.className = "flex items-center space-x-2";
        div.innerHTML = `
        <label class="w-20">${players[idx]}</label>
        <input type="number" min="0" class="p-1 rounded bid-input w-20" onchange="handleBidInput(${idx})" id="bid-${idx}" required />
      `;
        container.appendChild(div);
      }
      document.getElementById("bid-warning").innerText = "";
      document.getElementById("bid-section").classList.remove("hidden");
      document.getElementById("tricks-section").classList.add("hidden");

      document.querySelectorAll(".bid-input").forEach((input) => {
        input.addEventListener("change", updateBidSumStatus);
      });
      updateBidSumStatus(); // åˆå§‹åŒ–ä¼°å¢©ç¸½å’Œç‹€æ…‹
    }

    function handleBidInput(index) {
      const val = parseInt(document.getElementById(`bid-${index}`).value);
      currentBids[index] = isNaN(val) ? null : val;

      // ä¼°å¢©è¼¸å…¥å®Œæˆå…ˆæª¢æŸ¥ç¸½å’Œ
      if (currentBids.filter(v => v !== null).length === players.length) {
        const total = currentBids.reduce((a, b) => a + b, 0);
        if (total === round) {
          document.getElementById("bid-warning").innerText = `ä¼°å¢©ç¸½å’Œå””å¯ä»¥ç­‰æ–¼ ${round}`;
        } else {
          document.getElementById("bid-warning").innerText = "";
        }
      }
    }

    function submitBids() {
      if (event) event.preventDefault();
      if (currentBids.includes(null)) return alert("è«‹å®Œæˆæ‰€æœ‰ç©å®¶å˜…ä¼°å¢©");
      const total = currentBids.reduce((a, b) => a + b, 0);
      if (total === round) return alert(`ä¼°å¢©ç¸½å’Œå””å¯ä»¥ç­‰æ–¼ ${round}`);

      // æ–°å¢ç©º round entryï¼Œç¨å¾Œ submitTricks å†è£œå®Œ actuals
      rounds[round - 1] = { bids: [...currentBids], actuals: Array(players.length).fill(null) };

      // ä¼°å¢©å®Œæˆï¼Œæº–å‚™å¯¦éš›å¢©æ•¸è¼¸å…¥
      document.getElementById("bid-section").classList.add("hidden");
      document.getElementById("tricks-section").classList.remove("hidden");

      showTrickInputs();
      updateScoreboard(); // ä¼°å¢©æäº¤å¾Œå³æ™‚æ›´æ–°åˆ†æ•¸æ¿é¡¯ç¤ºä¼°å¢©
    }

    function showTrickInputs() {
      currentTricks = Array(players.length).fill(null);
      const container = document.getElementById("trick-inputs");
      container.innerHTML = "";

      // header row
      const headerDiv = document.createElement("div");
      headerDiv.className = "flex items-center space-x-2 font-semibold border-b border-gray-600 pb-1 mb-2";
      headerDiv.innerHTML = `
      <div class="w-20">ç©å®¶</div>
      <div class="w-12 text-right">ä¼°å¢©</div>
      <div class="w-20">å¯¦éš›å¢©æ•¸</div>
      <div class="w-20">çµæœ</div>
    `;
      container.appendChild(headerDiv);

      for (let i = 0; i < players.length; i++) {
        const idx = (dealerIndex + i) % players.length;
        const div = document.createElement("div");
        div.className = "flex items-center space-x-2";
        div.innerHTML = `
        <label class="w-20">${players[idx]}</label>
        <div class="w-12 text-right font-semibold">${currentBids[idx]}</div>
        <input type="number" min="0" class="p-1 rounded w-20" onchange="handleTrickInput(${idx})" id="trick-${idx}" required />
        <div id="result-msg-${idx}" class="w-20 font-semibold"></div>
      `;
        container.appendChild(div);
      }
    }

    function handleTrickInput(index) {
      const val = parseInt(document.getElementById(`trick-${index}`).value);
      currentTricks[index] = isNaN(val) ? null : val;

      // é¡¯ç¤ºæˆåŠŸæˆ–å¤±æ•—è¨Šæ¯
      const msgDiv = document.getElementById(`result-msg-${index}`);
      if (currentTricks[index] === null) {
        msgDiv.innerText = "";
        return;
      }
      if (currentTricks[index] === currentBids[index]) {
        msgDiv.innerText = "æˆåŠŸ!";
        msgDiv.classList.remove("text-red-600");
        msgDiv.classList.add("text-yellow-400");
      } else {
        msgDiv.innerText = "å¤±æ•—";
        msgDiv.classList.remove("text-yellow-400");
        msgDiv.classList.add("text-red-600");
      }
    }

    function submitTricks() {
      if (event) event.preventDefault();
      if (currentTricks.includes(null)) return alert("è«‹å®Œæˆæ‰€æœ‰ç©å®¶å˜…å¯¦éš›å¢©æ•¸");

      // å„²å­˜ actuals
      rounds[round - 1].actuals = [...currentTricks];

      // è¨ˆåˆ†
      for (let i = 0; i < players.length; i++) {
        if (currentTricks[i] === currentBids[i]) {
          scores[i] += 10 + Math.pow(2, currentBids[i]);
        } else {
          scores[i] -= currentBids[i];
        }
      }
      updateScoreboard();

      // ä¸‹ä¸€å›åˆæº–å‚™
      round++;
      dealerIndex = (dealerIndex + 1) % players.length;
      if (round > maxRounds) {
        alert("éŠæˆ²å®Œçµï¼");
        return;
      }

      document.getElementById("tricks-section").classList.add("hidden");
      showBidInputs();
      updateRoundDisplay();
    }

    function updateScoreboard() {
      const table = document.getElementById("scoreboard");
      table.innerHTML = ""; // Clear existing content

      const thead = document.createElement("thead");
      thead.className = "bg-gray-800";

      const headerRow = document.createElement("tr");

      // ç¬¬ä¸€æ¬„ï¼šç©å®¶å
      const playerHeader = document.createElement("th");
      playerHeader.textContent = "ç©å®¶";
      playerHeader.className = "border border-gray-700 p-2";
      headerRow.appendChild(playerHeader);

      // æ¯å›åˆï¼šä¼°å¢©ã€å¯¦éš›ã€çµæœ (ä¸‰å€‹æ¬„)
      if (typeof rounds !== 'undefined') {
        rounds.forEach((_, index) => {
          ["ä¼°å¢©", "å¯¦å¢©", "çµæœ"].forEach((label) => {
            const th = document.createElement("th");
            th.textContent = `R${index + 1}${label}`;
            th.className = "border border-gray-700 p-2 whitespace-pre-wrap";
            headerRow.appendChild(th);
          });
        });
      }

      // æœ€å¾Œä¸€æ¬„ï¼šç¸½åˆ†
      const scoreHeader = document.createElement("th");
      scoreHeader.textContent = "ç¸½åˆ†";
      scoreHeader.className = "border border-gray-700 p-2";
      headerRow.appendChild(scoreHeader);

      thead.appendChild(headerRow);
      table.appendChild(thead);

      // å»ºç«‹ tbody
      const tbody = document.createElement("tbody");
      tbody.className = "bg-gray-900";

      players.forEach((player, index) => {
        const row = document.createElement("tr");

        // ç©å®¶å
        const playerCell = document.createElement("td");
        playerCell.textContent = player;
        playerCell.className = "border border-gray-700 p-2";
        row.appendChild(playerCell);

        let totalScore = 0;

        for (let i = 0; i < rounds.length; i++) {
          const round = rounds[i];
          const bid = round.bids[index];
          const actual = round.actuals[index];

          // ä¼°å¢© cell
          const bidCell = document.createElement("td");
          bidCell.textContent = bid ?? "-";
          bidCell.className = "border border-gray-700 p-2 text-center";
          row.appendChild(bidCell);

          // å¯¦éš›å¢© cell
          const actualCell = document.createElement("td");
          actualCell.textContent = actual ?? "-";
          actualCell.className = "border border-gray-700 p-2 text-center";
          row.appendChild(actualCell);

          // çµæœ cell
          const resultCell = document.createElement("td");
          let result = "";
          let points = 0;

          if (bid !== null && actual !== null) {
            if (bid === actual) {
              result = "âœ”ï¸";
              resultCell.style.color = "gold";
              points = 10 + bid;
            } else {
              result = "âŒ";
              resultCell.style.color = "red";
              points = -Math.abs(bid - actual);
            }
            totalScore += points;
          }
          resultCell.textContent = result;
          resultCell.className = "border border-gray-700 p-2 text-center";
          row.appendChild(resultCell);
        }

        // ç¸½åˆ† cell
        const scoreCell = document.createElement("td");
        scoreCell.textContent = totalScore;
        scoreCell.className = "border border-gray-700 p-2 font-bold text-center";
        row.appendChild(scoreCell);

        // å¦‚æœä¿‚é ˜å…ˆè€…å°± highlight row
        if (totalScore === getMaxScore()) {
          row.style.backgroundColor = "#1e5128";
        }

        tbody.appendChild(row);
      });

      table.appendChild(tbody);
    }



    function getMaxScore() {
      const scores = players.map((_, index) => {
        return rounds.reduce((sum, round) => {
          const bid = round.bids[index];
          const actual = round.actuals[index];
          if (bid !== null && actual !== null) {
            return sum + (bid === actual ? 10 + bid : -Math.abs(bid - actual));
          }
          return sum;
        }, 0);
      });
      return Math.max(...scores);
    }


    function clearTrickSection() {
      currentTricks = Array(players.length).fill(null);
    }

    function updateBidSumStatus() {
      const inputs = document.querySelectorAll(".bid-input");
      let sum = 0;
      inputs.forEach((input) => {
        const val = parseInt(input.value);
        if (!isNaN(val)) sum += val;
      });

      const bidSumDiv = document.getElementById("bidSumStatus");
      bidSumDiv.innerText = `ä¼°å¢©ç¸½å’Œï¼š${sum}`;
      if (sum === round) {
        bidSumDiv.style.color = "red";
        bidSumDiv.innerText += " âŒ";
      } else {
        bidSumDiv.style.color = "lightgreen";
      }
    }

    if ("serviceWorker" in navigator) {
      navigator.serviceWorker
        .register("service-worker.js")
        .then(reg => console.log("Service Worker Registered", reg))
        .catch(err => console.error("Service Worker Error", err));
    }

  </script>

</body>

</html>