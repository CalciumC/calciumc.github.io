<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css" />
  <title>Flight Details</title>
  <style>
    body {
      max-width: 700px;
      margin: auto;
      padding: 1rem;
    }
    .details {
      margin-top: 1rem;
      border: 1px solid #ccc;
      border-radius: 0.5rem;
      padding: 1rem;
      background: #f9f9f9;
    }
    form {
      margin-top: 2rem;
    }
  </style>
</head>
<body>
  <h1>Flight Details</h1>

  <div class="details" id="flightInfo">
    <p><strong>Airline:</strong> <span id="airline"></span></p>
    <p><strong>From:</strong> <span id="from"></span> @ <span id="departureTime"></span></p>
    <p><strong>To:</strong> <span id="to"></span> @ <span id="arrivalTime"></span></p>
    <p><strong>Flight Duration:</strong> <span id="duration"></span></p>
    <p><strong>Distance:</strong> <span id="distance"></span></p>
    <p><strong>Overnight Flight:</strong> <span id="overnight"></span></p>
    <p><strong>Aircraft:</strong> <span id="aircraft"></span></p>
  </div>

  <form id="extraForm">
    <h2>Add Your Info</h2>
    <label>
      Booking Code:
      <input type="text" id="bookingCode" name="bookingCode" />
    </label>
    <label>
      Seat Number:
      <input type="text" id="seatNumber" name="seatNumber" />
    </label>
    <button type="submit">Save</button>
  </form>

  <script>
    const flightForm = document.getElementById('flightForm');
    const flightList = document.getElementById('flightList');
    const resetBtn = document.getElementById('resetBtn');
    const map = L.map('map').setView([20, 0], 2);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let flights = JSON.parse(localStorage.getItem('flights') || '[]');

    function getRandomColor(index) {
    const colors = ['#e6194b', '#3cb44b', '#ffe119', '#4363d8', '#f58231', '#911eb4', '#46f0f0', '#f032e6'];
    return colors[index % colors.length];
    }

    function saveFlights() {
    localStorage.setItem('flights', JSON.stringify(flights));
    }

    function renderFlights() {
    flightList.innerHTML = '';
    map.eachLayer(layer => {
        if (layer instanceof L.Polyline) map.removeLayer(layer);
    });

    const sortedFlights = [...flights].sort((a, b) => new Date(a.date) - new Date(b.date));

    sortedFlights.forEach((f, i) => {
        const card = document.createElement('div');
        card.className = 'flight-card';

        const depTimeFormatted = f.departureTime ? new Date(f.departureTime).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'}) : '';
        const arrTimeFormatted = f.arrivalTime ? new Date(f.arrivalTime).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'}) : '';

        const info = document.createElement('div');
        info.className = 'flight-info';
        info.innerHTML = `
        <strong><a href="details.html?flightNumber=${encodeURIComponent(f.flightNumber)}&date=${encodeURIComponent(f.date)}">${f.flightNumber}</a></strong><br>
        ${f.from} → ${f.to}<br>
        ${f.date}<br>
        Departure: ${depTimeFormatted} - Arrival: ${arrTimeFormatted}<br>
        ${f.airline || ''}
        `;

        const actions = document.createElement('div');
        actions.className = 'flight-actions';

        const editBtn = document.createElement('button');
        editBtn.textContent = 'Edit';
        editBtn.onclick = () => {
        const newDate = prompt('Edit flight date:', f.date);
        if (newDate) {
            flights[flights.findIndex(fl => fl.flightNumber === f.flightNumber && fl.date === f.date)] = { ...f, date: newDate };
            saveFlights();
            renderFlights();
        }
        };

        const removeBtn = document.createElement('button');
        removeBtn.textContent = 'Remove';
        removeBtn.onclick = () => {
        if (confirm('Are you sure you want to delete this flight?')) {
            flights = flights.filter(fl => !(fl.flightNumber === f.flightNumber && fl.date === f.date));
            saveFlights();
            renderFlights();
        }
        };

        actions.appendChild(editBtn);
        actions.appendChild(removeBtn);
        card.appendChild(info);
        card.appendChild(actions);
        flightList.appendChild(card);

        if (f.coords) {
        const polyline = L.polyline(f.coords, {
            color: getRandomColor(i),
            weight: 4
        }).addTo(map);

        polyline.bindTooltip(
            `${f.flightNumber}<br>${f.from} → ${f.to}<br>${f.date}<br>${f.airline || ''}`,
            { permanent: false, sticky: true, direction: 'top' }
        );
        }
    });
    }

    async function getAirportCoords(code) {
    const response = await fetch(`https://raw.githubusercontent.com/mwgg/Airports/master/airports.json`);
    const data = await response.json();
    const airport = Object.values(data).find(a => a.iata === code);
    return airport ? [airport.lat, airport.lon] : null;
    }

    const AVIATIONSTACK_API_KEY = '2482f6676b81992622bbe0d7ee97c0e5';
    const AERODATABOX_API_KEY = 'a2e2185d14msh9356b6a5b53e093p1fddffjsn4696d33cc2d6'; // Replace with your actual AeroDataBox API key

    async function lookupFlight(flightNumber, flightDate) {
    const today = new Date().toISOString().slice(0, 10);

    if (flightDate >= today) {
        // Future flight: use AeroDataBox API
        try {
        const response = await fetch(`https://aerodatabox.p.rapidapi.com/flights/number/${flightNumber}/date/${flightDate}`, {
            method: 'GET',
            headers: {
            'X-RapidAPI-Key': AERODATABOX_API_KEY,
            'X-RapidAPI-Host': 'aerodatabox.p.rapidapi.com'
            }
        });
        const data = await response.json();
        const flight = data?.flights?.[0]; // adjust based on actual API response
        
        if (!flight) return null;

        return {
            flightNumber,
            from: flight.departure.iataCode,
            to: flight.arrival.iataCode,
            date: flightDate,
            airline: flight.airline?.name || flight.airline?.iata || '',
            departureTime: flight.departure.scheduledTimeLocal,
            arrivalTime: flight.arrival.scheduledTimeLocal
        };
        } catch (error) {
        console.error('AeroDataBox API error:', error);
        return null;
        }
    } else {
        // Past or today: use AviationStack API
        try {
        const response = await fetch(`https://api.aviationstack.com/v1/flights?access_key=${AVIATIONSTACK_API_KEY}&flight_iata=${flightNumber}`);
        const data = await response.json();
        // find flight matching the date or fallback first flight
        const flight = data?.data?.find(f => f.departure.scheduled?.startsWith(flightDate)) || data?.data?.[0];
        if (!flight) return null;

        return {
            flightNumber,
            from: flight.departure.iata,
            to: flight.arrival.iata,
            date: flight.departure.scheduled?.split('T')[0] || flight.flight_date,
            airline: flight.airline?.name || '',
            departureTime: flight.departure.scheduled,
            arrivalTime: flight.arrival.scheduled
        };
        } catch (error) {
        console.error('AviationStack API error:', error);
        return null;
        }
    }
    }

    flightForm.onsubmit = async (e) => {
    e.preventDefault();
    const flightNumber = document.getElementById('flightNumber').value.trim().toUpperCase();
    let userDate = document.getElementById('flightDate').value;

    if (!userDate) {
        // if no date provided, fallback to today
        userDate = new Date().toISOString().slice(0, 10);
    }

    const result = await lookupFlight(flightNumber, userDate);
    if (!result) {
        alert('Flight not found or API error. You can still add it manually.');
        // fallback: save minimal flight with user input data only
        const minimalFlight = {
        flightNumber,
        from: '',
        to: '',
        date: userDate,
        airline: '',
        departureTime: '',
        arrivalTime: '',
        coords: null
        };
        flights.push(minimalFlight);
        saveFlights();
        renderFlights();
        flightForm.reset();
        return;
    }

    const fromCoords = await getAirportCoords(result.from);
    const toCoords = await getAirportCoords(result.to);
    const coords = fromCoords && toCoords ? [fromCoords, toCoords] : null;

    const flight = { ...result, coords };
    flights.push(flight);
    saveFlights();
    renderFlights();
    flightForm.reset();
    };

    resetBtn.onclick = () => {
    if (confirm('Are you sure you want to clear all stored flight records?')) {
        localStorage.removeItem('flights');
        flights = [];
        renderFlights();
    }
    };

    renderFlights();

  </script>
</body>
</html>
