<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css" />
  <style>
    body {
      max-width: 800px;
      margin: auto;
      padding: 1rem;
      position: relative;
    }

    h1 {
      text-align: center;
    }

    #map {
      width: 100vw;
      height: 400px;
      margin-left: -1rem;
      margin-right: -1rem;
      border-radius: 0;
    }

    form {
      display: grid;
      grid-template-columns: 2fr 1fr auto;
      gap: 0.5rem;
      align-items: center;
    }

    .flight-card {
      background: #ffffff;
      border: 1px solid #ccc;
      border-radius: 0.5rem;
      padding: 0.75rem;
      margin-bottom: 0.75rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
      color: #333;
    }

    .flight-info {
      flex: 1;
    }

    .flight-actions button {
      margin-left: 0.25rem;
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
    }

    #resetBtn {
      font-size: 0.85rem;
      padding: 0.4rem 0.8rem;
      position: static;
      /* changed from fixed */
      margin-top: 1rem;
      display: inline-block;
    }

    main>button#resetBtn {
      float: right;
    }

    .version {
      position: fixed;
      bottom: 8px;
      right: 12px;
      font-size: 0.75rem;
      color: #888;
      background: rgba(255, 255, 255, 0.7);
      padding: 2px 6px;
      border-radius: 4px;
      pointer-events: none;
      z-index: 999;
    }
  </style>
  <title>My Flights Tracker</title>
</head>

<body>
  <div id="map"></div>
  <main>
    <h1>✈️ My Flights Tracker</h1>
    <form id="flightForm">
      <input type="text" placeholder="Flight Number (e.g. BA183)" id="flightNumber" required />
      <input type="date" id="flightDate" />
      <button type="submit">Add</button>
    </form>

    

    <h2>Flight Log</h2>
    <div id="flightList"></div>
    <button id="resetBtn">Reset All Flights</button>
  </main>
  <div class="version">v1.0.3</div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const flightForm = document.getElementById('flightForm');
    const flightList = document.getElementById('flightList');
    const resetBtn = document.getElementById('resetBtn');
    const map = L.map('map').setView([20, 0], 2);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let flights = JSON.parse(localStorage.getItem('flights') || '[]');

    function getRandomColor(index) {
      const colors = ['#e6194b', '#3cb44b', '#ffe119', '#4363d8', '#f58231', '#911eb4', '#46f0f0', '#f032e6'];
      return colors[index % colors.length];
    }

    function saveFlights() {
      localStorage.setItem('flights', JSON.stringify(flights));
    }

    function renderFlights() {
      flightList.innerHTML = '';
      map.eachLayer(layer => {
        if (layer instanceof L.Polyline) map.removeLayer(layer);
      });

      const sortedFlights = [...flights].sort((a, b) => new Date(a.date) - new Date(b.date));

      sortedFlights.forEach((f, i) => {
        const card = document.createElement('div');
        card.className = 'flight-card';

        const depTimeFormatted = f.departureTime ? new Date(f.departureTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
        const arrTimeFormatted = f.arrivalTime ? new Date(f.arrivalTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';

        const info = document.createElement('div');
        info.className = 'flight-info';
        info.innerHTML = `
        <strong><a href="details.html?flightNumber=${encodeURIComponent(f.flightNumber)}&date=${encodeURIComponent(f.date)}">${f.flightNumber}</a></strong><br>
        ${f.from} → ${f.to}<br>
        ${f.date}<br>
        Departure: ${depTimeFormatted} - Arrival: ${arrTimeFormatted}<br>
        ${f.airline || ''}
        `;

        const actions = document.createElement('div');
        actions.className = 'flight-actions';

        const editBtn = document.createElement('button');
        editBtn.textContent = 'Edit';
        editBtn.onclick = () => {
          const newDate = prompt('Edit flight date:', f.date);
          if (newDate) {
            flights[flights.findIndex(fl => fl.flightNumber === f.flightNumber && fl.date === f.date)] = { ...f, date: newDate };
            saveFlights();
            renderFlights();
          }
        };

        const removeBtn = document.createElement('button');
        removeBtn.textContent = 'Remove';
        removeBtn.onclick = () => {
          if (confirm('Are you sure you want to delete this flight?')) {
            flights = flights.filter(fl => !(fl.flightNumber === f.flightNumber && fl.date === f.date));
            saveFlights();
            renderFlights();
          }
        };

        actions.appendChild(editBtn);
        actions.appendChild(removeBtn);
        card.appendChild(info);
        card.appendChild(actions);
        flightList.appendChild(card);

        if (f.coords && f.coords.length === 2) {
          const [from, to] = f.coords;
          const offsetMagnitude = 0.6; // Increased for better separation

          const dx = to[1] - from[1]; // lon difference
          const dy = to[0] - from[0]; // lat difference
          const length = Math.sqrt(dx * dx + dy * dy);

          if (length === 0) return; // avoid collapsing line

          // Perpendicular offset unit vector
          const offsetX = -dy / length;
          const offsetY = dx / length;

          // Apply a unique offset per flight (you can use flight index or hash)
          const direction = (i % 2 === 0 ? 1 : -1);
          const offsetLat = offsetY * offsetMagnitude * direction * (Math.floor(i / 2) + 1);
          const offsetLon = offsetX * offsetMagnitude * direction * (Math.floor(i / 2) + 1);

          const offsetCoords = [
            [from[0] + offsetLat, from[1] + offsetLon],
            [to[0] + offsetLat, to[1] + offsetLon]
          ];

          const polyline = L.polyline(offsetCoords, {
            color: getRandomColor(i),
            weight: 4
          }).addTo(map);

          polyline.bindTooltip(
            `${f.flightNumber}<br>${f.from} → ${f.to}<br>${f.date}<br>${f.airline || ''}`,
            { permanent: false, sticky: true, direction: 'top' }
          );
        }


      });
    }

    async function getAirportCoords(code) {
      const response = await fetch(`https://raw.githubusercontent.com/mwgg/Airports/master/airports.json`);
      const data = await response.json();
      const airport = Object.values(data).find(a => a.iata === code);
      return airport ? [airport.lat, airport.lon] : null;
    }

    const AVIATIONSTACK_API_KEY = '2482f6676b81992622bbe0d7ee97c0e5';
    const AERODATABOX_API_KEY = 'a2e2185d14msh9356b6a5b53e093p1fddffjsn4696d33cc2d6'; // Replace with your actual AeroDataBox API key

    async function lookupFlight(flightNumber, flightDate) {
      try {
        const response = await fetch(`https://aerodatabox.p.rapidapi.com/flights/number/${flightNumber}/${flightDate}`, {
          method: 'GET',
          headers: {
            'X-RapidAPI-Key': AERODATABOX_API_KEY,
            'X-RapidAPI-Host': 'aerodatabox.p.rapidapi.com'
          }
        });
        const flightsData = await response.json();
        const flight = flightsData?.[0];
        if (!flight) return null;

        return {
          flightNumber: flight.number,
          from: flight.departure.airport.iata,
          to: flight.arrival.airport.iata,
          date: flight.departure.scheduledTime.local.split(' ')[0],
          airline: flight.airline?.name || '',
          departureTime: flight.departure.scheduledTime.local,
          arrivalTime: flight.arrival.scheduledTime.local,
          departureTimeZone: flight.departure.airport.timeZone,
          arrivalTimeZone: flight.arrival.airport.timeZone,
          aircraftModel: flight.aircraft?.model || '',
          distanceKm: flight.greatCircleDistance.km,
          coords: [
            [flight.departure.airport.location.lat, flight.departure.airport.location.lon],
            [flight.arrival.airport.location.lat, flight.arrival.airport.location.lon]
          ]
        };
      } catch (e) {
        console.error('AeroDataBox error', e);
        return null;
      }
    }

    flightForm.onsubmit = async (e) => {
      e.preventDefault();
      const flightNumber = document.getElementById('flightNumber').value.trim().toUpperCase();
      let userDate = document.getElementById('flightDate').value;

      if (!userDate) {
        // if no date provided, fallback to today
        userDate = new Date().toISOString().slice(0, 10);
      }

      const result = await lookupFlight(flightNumber, userDate);
      // if (!result) {
      //   alert('Flight not found or API error. You can still add it manually.');
      //   // fallback: save minimal flight with user input data only
      //   const minimalFlight = {
      //     flightNumber,
      //     from: '',
      //     to: '',
      //     date: userDate,
      //     airline: '',
      //     departureTime: '',
      //     arrivalTime: '',
      //     coords: null
      //   };
      //   flights.push(minimalFlight);
      //   saveFlights();
      //   renderFlights();
      //   flightForm.reset();
      //   return;
      // }
      if (!result) {
        alert('Flight not found or not available from any provider.');
        return; // Do NOT add to log
      }

      const fromCoords = await getAirportCoords(result.from);
      const toCoords = await getAirportCoords(result.to);
      const coords = fromCoords && toCoords ? [fromCoords, toCoords] : null;

      const flight = { ...result, coords };
      flights.push(flight);
      saveFlights();
      renderFlights();
      flightForm.reset();
    };

    resetBtn.onclick = () => {
      if (confirm('Are you sure you want to clear all stored flight records?')) {
        localStorage.removeItem('flights');
        flights = [];
        renderFlights();
      }
    };

    renderFlights();

  </script>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js');
    }
  </script>
</body>

</html>